<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    k8s之存储 |  自在技术博客
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  <link rel="stylesheet" href="/dist/main.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

</head>

</html>

<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article id="post-k8s之存储" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  k8s之存储
</h1>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/06/04/k8s之存储/" class="article-date">
  <time datetime="2020-06-04T01:06:00.000Z" itemprop="datePublished">2020-06-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/kubernetes/">kubernetes</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">5.6k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">26 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>为了保证数据的持久性，必须保证数据在外部存储在docker容器中，为了实现数据的持久性存储，在宿主机和容器内做映射，可以保证在容器的生命周期结束，数据依旧可以实现持久性存储。但是在k8s中，由于*pod分布在各个不同的节点之上，并不能实现不同节点之间持久性数据的共享，并且，在节点故障时，可能会导致数据的永久性丢失。为此，k8s就引入了外部存储卷的功能。</p>
<p>k8s的存储卷类型：</p>
<ol>
<li><code>emptyDir</code>（临时目录）:Pod删除，数据也会被清除，这种存储成为emptyDir，用于数据的临时存储。</li>
<li><code>hostPath</code> (宿主机目录映射):</li>
<li><code>本地的SAN</code> (iSCSI,FC)、NAS(nfs,cifs,http)存储</li>
<li><code>分布式存储</code>（glusterfs，rbd，cephfs）</li>
<li><code>云存储</code>（EBS，Azure Disk）</li>
</ol>
<p><font color="32CD32">k8s整体存储概念为</font>：实际存储空间（nfs，hostpath…）—&gt; pv（抽象的存储卷，从实际的存储空间划分）—&gt; pvc（存储卷创建申请，从pv中划分定义）—&gt; pod（在创建pod中引用pvc进行挂在）</p>
<p>参考链接：<a href="https://www.cnblogs.com/linuxk/p/9760363.html" target="_blank" rel="noopener">https://www.cnblogs.com/linuxk/p/9760363.html</a></p>
<h1 id="emptyDir存储卷演示"><a href="#emptyDir存储卷演示" class="headerlink" title="emptyDir存储卷演示"></a>emptyDir存储卷演示</h1><p>一个emptyDir 第一次创建是在一个pod被指定到具体node的时候，并且会一直存在在pod的生命周期当中，正如它的名字一样，它初始化是一个空的目录，pod中的容器都可以读写这个目录，这个目录可以被挂在到各个容器相同或者不相同的的路径下。当一个pod因为任何原因被移除的时候，这些数据会被永久删除。注意：一个容器崩溃了不会导致数据的丢失，因为容器的崩溃并不移除pod。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl explain pods.spec.volumes.emptyDir  #查看emptyDir存储定义</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl explain pods.spec.containers.volumeMounts  #查看容器挂载方式</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># cd mainfests &amp;&amp; mkdir volumes &amp;&amp; cd volumes</span></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># cp ../pod-demo.yaml ./</span></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># mv pod-demo.yaml pod-vol-demo.yaml</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># vim pod-vol-demo.yaml   #创建emptyDir的清单</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-demo</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">    tier: frontend</span><br><span class="line">  annotations:</span><br><span class="line">    magedu.com/create-by:<span class="string">"cluster admin"</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp</span><br><span class="line">    image: ikubernetes/myapp:v1</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">    - name: http</span><br><span class="line">      containerPort: 80</span><br><span class="line">    volumeMounts:    <span class="comment">#在容器内定义挂载存储名称和挂载路径</span></span><br><span class="line">    - name: html</span><br><span class="line">      mountPath: /usr/share/nginx/html/</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: busybox:latest</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: html</span><br><span class="line">      mountPath: /data/    <span class="comment">#在容器内定义挂载存储名称和挂载路径</span></span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">'/bin/sh'</span>,<span class="string">'-c'</span>,<span class="string">'while true;do echo $(date) &gt;&gt; /data/index.html;sleep 2;done'</span>]</span><br><span class="line">  volumes:  <span class="comment">#定义存储卷</span></span><br><span class="line">  - name: html    <span class="comment">#定义存储卷名称  </span></span><br><span class="line">    emptyDir: &#123;&#125;  <span class="comment">#定义存储卷类型</span></span><br><span class="line">    </span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl apply -f pod-vol-demo.yaml </span></span><br><span class="line">pod/pod-vol-demo created </span><br><span class="line"></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                                 READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod-vol-demo                         2/2       Running   0          27s</span><br><span class="line"></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">NAME                      READY     STATUS    RESTARTS   AGE       IP            NODE</span><br><span class="line">......</span><br><span class="line">pod-vol-demo              2/2       Running   0          16s       10.244.2.34   k8s-node02</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在上面，我们定义了2个容器，其中一个容器是输入日期到index.html中，然后验证访问nginx的html是否可以获取日期。以验证两个容器之间挂载的emptyDir实现共享。如下访问验证:</span></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># curl 10.244.2.34  #访问验证</span></span><br><span class="line">Tue Oct 9 03:56:53 UTC 2018</span><br><span class="line">Tue Oct 9 03:56:55 UTC 2018</span><br><span class="line">Tue Oct 9 03:56:57 UTC 2018</span><br><span class="line">Tue Oct 9 03:56:59 UTC 2018</span><br><span class="line">Tue Oct 9 03:57:01 UTC 2018</span><br><span class="line">Tue Oct 9 03:57:03 UTC 2018</span><br><span class="line">Tue Oct 9 03:57:05 UTC 2018</span><br><span class="line">Tue Oct 9 03:57:07 UTC 2018</span><br><span class="line">Tue Oct 9 03:57:09 UTC 2018</span><br><span class="line">Tue Oct 9 03:57:11 UTC 2018</span><br><span class="line">Tue Oct 9 03:57:13 UTC 2018</span><br><span class="line">Tue Oct 9 03:57:15 UTC 2018</span><br></pre></td></tr></table></figure>

<h1 id="hostPath存储卷演示"><a href="#hostPath存储卷演示" class="headerlink" title="hostPath存储卷演示"></a>hostPath存储卷演示</h1><p>hostPath宿主机路径，就是把pod所在的宿主机之上的脱离pod中的容器名称空间的之外的宿主机的文件系统的某一目录和pod建立关联关系，在pod删除时，存储数据不会丢失。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master volumes]<span class="comment"># vim pod-hostpath-vol.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-vol-hostpath</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp</span><br><span class="line">    image: ikubernetes/myapp:v1</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: html</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">    - name: html</span><br><span class="line">      hostPath:</span><br><span class="line">        path: /data/pod/volume1</span><br><span class="line">        <span class="built_in">type</span>: DirectoryOrCreate</span><br><span class="line"><span class="comment"># DirectoryOrCreate  宿主机上不存在创建此目录  </span></span><br><span class="line"><span class="comment"># Directory 必须存在挂载目录  </span></span><br><span class="line"><span class="comment"># FileOrCreate 宿主机上不存在挂载文件就创建  </span></span><br><span class="line"><span class="comment"># File 必须存在文件  </span></span><br><span class="line"></span><br><span class="line">[root@k8s-node01 ~]<span class="comment"># mkdir -p /data/pod/volume1</span></span><br><span class="line">[root@k8s-node01 ~]<span class="comment"># vim /data/pod/volume1/index.html</span></span><br><span class="line">node01.magedu.com</span><br><span class="line">[root@k8s-node02 ~]<span class="comment"># mkdir -p /data/pod/volume1</span></span><br><span class="line">[root@k8s-node02 ~]<span class="comment"># vim /data/pod/volume1/index.html</span></span><br><span class="line">node02.magedu.com</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl apply -f pod-hostpath-vol.yaml </span></span><br><span class="line">pod/pod-vol-hostpath created</span><br><span class="line"></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">NAME                                 READY     STATUS    RESTARTS   AGE       IP            NODE</span><br><span class="line">......</span><br><span class="line">pod-vol-hostpath                     1/1       Running   0          37s       10.244.2.35   k8s-node02</span><br><span class="line">......</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># curl 10.244.2.35</span></span><br><span class="line">node02.magedu.com</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl delete -f pod-hostpath-vol.yaml  #删除pod，再重建，验证是否依旧可以访问原来的内容</span></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl apply -f pod-hostpath-vol.yaml </span></span><br><span class="line">pod/pod-vol-hostpath created</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># curl  10.244.2.37 </span></span><br><span class="line">node02.magedu.com</span><br></pre></td></tr></table></figure>

<h1 id="nfs共享存储卷演示"><a href="#nfs共享存储卷演示" class="headerlink" title="nfs共享存储卷演示"></a>nfs共享存储卷演示</h1><p>nfs使的我们可以挂在已经存在的共享到的我们的Pod中，和emptyDir不同的是，emptyDir会被删除当我们的Pod被删除的时候，但是nfs不会被删除，仅仅是解除挂在状态而已，这就意味着NFS能够允许我们提前对数据进行处理，而且这些数据可以在Pod之间相互传递.并且，nfs可以同时被多个pod挂在并进行读写。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">（1）在stor01节点上安装nfs，并配置nfs服务</span><br><span class="line">[root@stor01 ~]<span class="comment"># yum install -y nfs-utils  ==》192.168.56.14</span></span><br><span class="line">[root@stor01 ~]<span class="comment"># mkdir /data/volumes -pv</span></span><br><span class="line">[root@stor01 ~]<span class="comment"># vim /etc/exports</span></span><br><span class="line">/data/volumes 192.168.56.0/24(rw,no_root_squash)</span><br><span class="line">[root@stor01 ~]<span class="comment"># systemctl start nfs</span></span><br><span class="line">[root@stor01 ~]<span class="comment"># showmount -e</span></span><br><span class="line">Export list <span class="keyword">for</span> stor01:</span><br><span class="line">/data/volumes 192.168.56.0/24</span><br><span class="line"></span><br><span class="line">（2）在node01和node02节点上安装nfs-utils，并测试挂载</span><br><span class="line">[root@k8s-node01 ~]<span class="comment"># yum install -y nfs-utils</span></span><br><span class="line">[root@k8s-node02 ~]<span class="comment"># yum install -y nfs-utils</span></span><br><span class="line">[root@k8s-node02 ~]<span class="comment"># mount -t nfs stor01:/data/volumes /mnt</span></span><br><span class="line">[root@k8s-node02 ~]<span class="comment"># mount</span></span><br><span class="line">......</span><br><span class="line">stor01:/data/volumes on /mnt <span class="built_in">type</span> nfs4 (rw,relatime,vers=4.1,rsize=131072,wsize=131072,namlen=255,hard,proto=tcp,port=0,timeo=600,retrans=2,sec=sys,clientaddr=192.168.56.13,local_lock=none,addr=192.168.56.14)</span><br><span class="line">[root@k8s-node02 ~]<span class="comment"># umount /mnt/</span></span><br><span class="line"></span><br><span class="line">（3）创建nfs存储卷的使用清单</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># cp pod-hostpath-vol.yaml pod-nfs-vol.yaml</span></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># vim pod-nfs-vol.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-vol-nfs</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp</span><br><span class="line">    image: ikubernetes/myapp:v1</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: html</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">    - name: html</span><br><span class="line">      nfs:</span><br><span class="line">        path: /data/volumes</span><br><span class="line">        server: stor01</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl apply -f pod-nfs-vol.yaml </span></span><br><span class="line">pod/pod-vol-nfs created</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">NAME                     READY     STATUS    RESTARTS   AGE       IP            NODE</span><br><span class="line">pod-vol-nfs              1/1       Running   0          21s       10.244.2.38   k8s-node02</span><br><span class="line"></span><br><span class="line">（3）在nfs服务器上创建index.html</span><br><span class="line">[root@stor01 ~]<span class="comment"># cd /data/volumes</span></span><br><span class="line">[root@stor01 volumes ~]<span class="comment"># vim index.html</span></span><br><span class="line">&lt;h1&gt; nfs stor01&lt;/h1&gt;</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># curl 10.244.2.38</span></span><br><span class="line">&lt;h1&gt; nfs stor01&lt;/h1&gt;</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl delete -f pod-nfs-vol.yaml   #删除nfs相关pod，再重新创建，可以得到数据的持久化存储</span></span><br><span class="line">pod <span class="string">"pod-vol-nfs"</span> deleted</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl apply -f pod-nfs-vol.yaml</span></span><br></pre></td></tr></table></figure>

<h1 id="NFS使用PV和PVC"><a href="#NFS使用PV和PVC" class="headerlink" title="NFS使用PV和PVC"></a>NFS使用PV和PVC</h1><h2 id="1、配置nfs存储"><a href="#1、配置nfs存储" class="headerlink" title="1、配置nfs存储"></a>1、配置nfs存储</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@stor01 volumes]<span class="comment"># mkdir v&#123;1,2,3,4,5&#125;</span></span><br><span class="line">[root@stor01 volumes]<span class="comment"># vim /etc/exports</span></span><br><span class="line">/data/volumes/v1 192.168.56.0/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v2 192.168.56.0/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v3 192.168.56.0/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v4 192.168.56.0/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v5 192.168.56.0/24(rw,no_root_squash)</span><br><span class="line">[root@stor01 volumes]<span class="comment"># exportfs -arv</span></span><br><span class="line">exporting 192.168.56.0/24:/data/volumes/v5</span><br><span class="line">exporting 192.168.56.0/24:/data/volumes/v4</span><br><span class="line">exporting 192.168.56.0/24:/data/volumes/v3</span><br><span class="line">exporting 192.168.56.0/24:/data/volumes/v2</span><br><span class="line">exporting 192.168.56.0/24:/data/volumes/v1</span><br><span class="line">[root@stor01 volumes]<span class="comment"># showmount -e</span></span><br><span class="line">Export list <span class="keyword">for</span> stor01:</span><br><span class="line">/data/volumes/v5 192.168.56.0/24</span><br><span class="line">/data/volumes/v4 192.168.56.0/24</span><br><span class="line">/data/volumes/v3 192.168.56.0/24</span><br><span class="line">/data/volumes/v2 192.168.56.0/24</span><br><span class="line">/data/volumes/v1 192.168.56.0/24</span><br></pre></td></tr></table></figure>

<h2 id="2、定义PV"><a href="#2、定义PV" class="headerlink" title="2、定义PV"></a>2、定义PV</h2><p>这里定义了pvc的访问模式为多路读写，该访问模式必须在前面pv定义的访问模式之中。定义PVC申请的大小为2Gi，此时PVC会自动去匹配多路读写且大小为2Gi的PV，匹配成功获取PVC的状态即为Bound</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl explain pv</span></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl explain pv.spec.nfs</span></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># vim pv-demo.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv001</span><br><span class="line">  labels:</span><br><span class="line">    name: pv001</span><br><span class="line">spec:</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/volumes/v1</span><br><span class="line">    server: stor01</span><br><span class="line">  accessModes: [<span class="string">"ReadWriteMany"</span>,<span class="string">"ReadWriteOnce"</span>]</span><br><span class="line">    <span class="comment">#accessModes（定义访问模型，有以下三种访问模型，以列表的方式存在，也就是说可以定义多个访问模式）</span></span><br><span class="line">    <span class="comment">#ReadWriteOnce（RWO）  单节点读写</span></span><br><span class="line">	<span class="comment">#ReadOnlyMany（ROX）  多节点只读</span></span><br><span class="line">	<span class="comment">#ReadWriteMany（RWX）  多节点读写</span></span><br><span class="line">  capacity:</span><br><span class="line">    storage: 1Gi</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv002</span><br><span class="line">  labels:</span><br><span class="line">    name: pv002</span><br><span class="line">spec:</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/volumes/v2</span><br><span class="line">    server: stor01</span><br><span class="line">  accessModes: [<span class="string">"ReadWriteOnce"</span>]</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 2Gi</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv003</span><br><span class="line">  labels:</span><br><span class="line">    name: pv003</span><br><span class="line">spec:</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/volumes/v3</span><br><span class="line">    server: stor01</span><br><span class="line">  accessModes: [<span class="string">"ReadWriteMany"</span>,<span class="string">"ReadWriteOnce"</span>]</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 2Gi</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv004</span><br><span class="line">  labels:</span><br><span class="line">    name: pv004</span><br><span class="line">spec:</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/volumes/v4</span><br><span class="line">    server: stor01</span><br><span class="line">  accessModes: [<span class="string">"ReadWriteMany"</span>,<span class="string">"ReadWriteOnce"</span>]</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 4Gi</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv005</span><br><span class="line">  labels:</span><br><span class="line">    name: pv005</span><br><span class="line">spec:</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/volumes/v5</span><br><span class="line">    server: stor01</span><br><span class="line">  accessModes: [<span class="string">"ReadWriteMany"</span>,<span class="string">"ReadWriteOnce"</span>]</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl apply -f pv-demo.yaml </span></span><br><span class="line">persistentvolume/pv001 created</span><br><span class="line">persistentvolume/pv002 created</span><br><span class="line">persistentvolume/pv003 created</span><br><span class="line">persistentvolume/pv004 created</span><br><span class="line">persistentvolume/pv005 created</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl get pv</span></span><br><span class="line">NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE</span><br><span class="line">pv001     1Gi        RWO,RWX        Retain           Available                                      7s</span><br><span class="line">pv002     2Gi        RWO            Retain           Available                                      7s</span><br><span class="line">pv003     2Gi        RWO,RWX        Retain           Available                                      7s</span><br><span class="line">pv004     4Gi        RWO,RWX        Retain           Available                                      7s</span><br><span class="line">pv005     5Gi        RWO,RWX        Retain           Available                                      7s</span><br></pre></td></tr></table></figure>

<h2 id="3、定义PVC"><a href="#3、定义PVC" class="headerlink" title="3、定义PVC"></a>3、定义PVC</h2><p>这里定义了pvc的访问模式为多路读写，该访问模式必须在前面pv定义的访问模式之中。定义PVC申请的大小为2Gi，此时PVC会自动去匹配多路读写且大小为2Gi的PV，匹配成功获取PVC的状态即为Bound</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master volumes ~]<span class="comment"># vim pod-vol-pvc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: mypvc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  accessModes: [<span class="string">"ReadWriteMany"</span>]</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 2Gi</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-vol-pvc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp</span><br><span class="line">    image: ikubernetes/myapp:v1</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: html</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">    - name: html</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: mypvc</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl apply -f pod-vol-pvc.yaml </span></span><br><span class="line">persistentvolumeclaim/mypvc created</span><br><span class="line">pod/pod-vol-pvc created</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl get pv</span></span><br><span class="line">NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM           STORAGECLASS   REASON    AGE</span><br><span class="line">pv001     1Gi        RWO,RWX        Retain           Available                                            19m</span><br><span class="line">pv002     2Gi        RWO            Retain           Available                                            19m</span><br><span class="line">pv003     2Gi        RWO,RWX        Retain           Bound       default/mypvc                            19m</span><br><span class="line">pv004     4Gi        RWO,RWX        Retain           Available                                            19m</span><br><span class="line">pv005     5Gi        RWO,RWX        Retain           Available                                            19m</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME      STATUS    VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">mypvc     Bound     pv003     2Gi        RWO,RWX                       22s</span><br></pre></td></tr></table></figure>

<h2 id="4、测试访问"><a href="#4、测试访问" class="headerlink" title="4、测试访问"></a>4、测试访问</h2><p>在存储服务器上创建index.html，并写入数据，通过访问Pod进行查看，可以获取到相应的页面。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@stor01 volumes]<span class="comment"># cd v3/</span></span><br><span class="line">[root@stor01 v3]<span class="comment"># echo "welcome to use pv3" &gt; index.html</span></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">pod-vol-pvc             1/1       Running   0          3m        10.244.2.39   k8s-node02</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># curl  10.244.2.39</span></span><br><span class="line">welcome to use pv3</span><br></pre></td></tr></table></figure>

<h1 id="StorageClass"><a href="#StorageClass" class="headerlink" title="StorageClass"></a>StorageClass</h1><p>在pv和pvc使用过程中存在的问题，在pvc申请存储空间时，未必就有现成的pv符合pvc申请的需求，上面nfs在做pvc可以成功的因素是因为我们做了指定的需求处理。那么当PVC申请的存储空间不一定有满足PVC要求的PV事，又该如何处理呢？？？为此，Kubernetes为管理员提供了描述存储”class（类）”的方法（StorageClass）。举个例子，在存储系统中划分一个1TB的存储空间提供给Kubernetes使用，当用户需要一个10G的PVC时，会立即通过restful发送请求，从而让存储空间创建一个10G的image，之后在我们的集群中定义成10G的PV供给给当前的PVC作为挂载使用。在此之前我们的存储系统必须支持restful接口，比如ceph分布式存储，而glusterfs则需要借助第三方接口完成这样的请求。</p>
<p>StorageClass 中包含 provisioner、parameters 和 reclaimPolicy 字段，当 class 需要动态分配 PersistentVolume 时会使用到。由于StorageClass需要一个独立的存储系统，此处就不再演示。</p>
<h1 id="配置容器应用：Secret和configMap"><a href="#配置容器应用：Secret和configMap" class="headerlink" title="配置容器应用：Secret和configMap"></a>配置容器应用：Secret和configMap</h1><p>在日常单机甚至集群状态下，我们需要对一个应用进行配置，只需要修改其配置文件即可。那么在容器中又该如何提供配置 信息呢？？？例如，为Nginx配置一个指定的server_name或worker进程数，为Tomcat的JVM配置其堆内存大小。传统的实践过程中通常有以下几种方式：</p>
<ul>
<li>启动容器时，通过命令传递参数</li>
<li>将定义好的配置文件通过镜像文件进行写入</li>
<li>通过环境变量的方式传递配置数据</li>
<li>挂载Docker卷传送配置文件</li>
</ul>
<p>而在Kubernetes系统之中也存在这样的组件，就是特殊的存储卷类型。其并不是提供pod存储空间，而是给管理员或用户提供从集群外部向Pod内部的应用注入配置信息的方式。这两种特殊类型的存储卷分别是：configMap和secret</p>
<ul>
<li><code>Secret</code>：用于向Pod传递敏感信息，比如密码，私钥，证书文件等，这些信息如果在容器中定义容易泄露，Secret资源可以让用户将这些信息存储在急群众，然后通过Pod进行挂载，实现敏感数据和系统解耦的效果。</li>
<li><code>ConfigMap</code>：主要用于向Pod注入非敏感数据，使用时，用户将数据直接存储在ConfigMap对象当中，然后Pod通过使用ConfigMap卷进行引用，实现容器的配置文件集中定义和管理。</li>
</ul>
<h2 id="Secret解析"><a href="#Secret解析" class="headerlink" title="Secret解析"></a>Secret解析</h2><p>Secret对象存储数据的方式是以键值方式存储数据，在Pod资源进行调用Secret的方式是通过环境变量或者存储卷的方式进行访问数据，解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者Pod Spec中。另外，Secret对象的数据存储和打印格式为Base64编码的字符串，因此用户在创建Secret对象时，也需要提供该类型的编码格式的数据。在容器中以环境变量或存储卷的方式访问时，会自动解码为明文格式。需要注意的是，如果是在Master节点上，Secret对象以非加密的格式存储在etcd中，所以需要对etcd的管理和权限进行严格控制。</p>
<p>Secret有4种类型：</p>
<ul>
<li><p>Service Account ：用来访问Kubernetes API，由Kubernetes自动创建，并且会自动挂载到Pod的/run/secrets/kubernetes.io/serviceaccount目录中；</p>
</li>
<li><p>Opaque ：base64编码格式的Secret，用来存储密码、密钥、信息、证书等，类型标识符为generic；</p>
</li>
<li><p>kubernetes.io/dockerconfigjson ：用来存储私有docker registry的认证信息，类型标识为docker-registry。</p>
</li>
<li><p>kubernetes.io/tls：用于为SSL通信模式存储证书和私钥文件，命令式创建类型标识为tls。</p>
</li>
</ul>
<p><strong>命令式创建</strong></p>
<p>1、通过 –from-literal：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create secret -h</span></span><br><span class="line">Create a secret using specified subcommand.</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  docker-registry Create a secret <span class="keyword">for</span> use with a Docker registry</span><br><span class="line">  generic         Create a secret from a <span class="built_in">local</span> file, directory or literal value</span><br><span class="line">  tls             Create a TLS secret</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  kubectl create secret [flags] [options]</span><br><span class="line"></span><br><span class="line">Use <span class="string">"kubectl &lt;command&gt; --help"</span> <span class="keyword">for</span> more information about a given <span class="built_in">command</span>.</span><br><span class="line">Use <span class="string">"kubectl options"</span> <span class="keyword">for</span> a list of global <span class="built_in">command</span>-line options (applies to all commands).</span><br><span class="line"></span><br><span class="line">每个 --from-literal 对应一个信息条目。</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create secret generic mysecret --from-literal=username=admin --from-literal=password=123456</span></span><br><span class="line">secret/mysecret created</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get secret</span></span><br><span class="line">NAME                    TYPE                                  DATA      AGE</span><br><span class="line">mysecret                Opaque                                2         6s</span><br></pre></td></tr></table></figure>

<p>2、通过 –from-file：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># echo -n admin &gt; ./username</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># echo -n 123456 &gt; ./password</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create secret generic mysecret --from-file=./username --from-file=./password </span></span><br><span class="line">secret/mysecret created</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get secret</span></span><br><span class="line">NAME                    TYPE                                  DATA      AGE</span><br><span class="line">mysecret                Opaque                                2         6s</span><br></pre></td></tr></table></figure>

<p>3、通过 –from-env-file：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># cat &lt;&lt; EOF &gt; env.txt</span></span><br><span class="line">&gt; username=admin</span><br><span class="line">&gt; password=123456</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create secret generic mysecret --from-env-file=env.txt </span></span><br><span class="line">secret/mysecret created</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get secret</span></span><br><span class="line">NAME                    TYPE                                  DATA      AGE</span><br><span class="line">mysecret                Opaque                                2         10s</span><br></pre></td></tr></table></figure>

<p><strong>清单式创建</strong></p>
<p>通过 YAML 配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#事先完成敏感数据的Base64编码</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># echo -n admin |base64</span></span><br><span class="line">YWRtaW4=</span><br><span class="line">[root@k8s-master ~]<span class="comment"># echo -n 123456 |base64</span></span><br><span class="line">MTIzNDU2</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim secret.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: mysecret</span><br><span class="line">data:</span><br><span class="line">  username: YWRtaW4=</span><br><span class="line">  password: MTIzNDU2</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl apply -f secret.yaml </span></span><br><span class="line">secret/mysecret created</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get secret  #查看存在的 secret，显示有2条数据</span></span><br><span class="line">NAME                    TYPE                                  DATA      AGE</span><br><span class="line">mysecret                Opaque                                2         8s</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl describe secret mysecret  #查看数据的 Key</span></span><br><span class="line">Name:         mysecret</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  </span><br><span class="line">Type:         Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">username:  5 bytes</span><br><span class="line">password:  6 bytes</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl edit secret mysecret  #查看具体的value，可以使用该命令</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  password: MTIzNDU2</span><br><span class="line">  username: YWRtaW4=</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">......</span><br><span class="line">[root@k8s-master ~]<span class="comment"># echo -n MTIzNDU2 |base64 --decode  #通过 base64 将 Value 反编码：</span></span><br><span class="line">123456</span><br><span class="line">[root@k8s-master ~]<span class="comment"># echo -n YWRtaW4= |base64 --decode</span></span><br><span class="line">admin</span><br></pre></td></tr></table></figure>

<p><strong>使用Secret</strong></p>
<p>Pod 可以通过 Volume 或者环境变量的方式使用 Secret</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master volumes]<span class="comment"># vim pod-secret-demo.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-secret</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: pod-secret</span><br><span class="line">    image: busybox</span><br><span class="line">    args:</span><br><span class="line">      - /bin/sh</span><br><span class="line">      - -c</span><br><span class="line">      - sleep 10;touch /tmp/healthy;sleep 30000</span><br><span class="line">    volumeMounts:   <span class="comment">#将 foo mount 到容器路径 /etc/foo，可指定读写权限为 readOnly。</span></span><br><span class="line">    - name: foo</span><br><span class="line">      mountPath: <span class="string">"/etc/foo"</span></span><br><span class="line">      readOnly: <span class="literal">true</span></span><br><span class="line">  volumes:    <span class="comment">#定义 volume foo，来源为 secret mysecret。</span></span><br><span class="line">  - name: foo</span><br><span class="line">    secret:</span><br><span class="line">      secretName: mysecret</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl apply -f pod-secret-demo.yaml </span></span><br><span class="line">pod/pod-secret created</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl get pods</span></span><br><span class="line">pod-secret                           1/1       Running   0          1m</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl exec -it pod-secret sh</span></span><br><span class="line">/ <span class="comment"># ls /etc/foo/</span></span><br><span class="line">password  username</span><br><span class="line">/ <span class="comment"># cat /etc/foo/username </span></span><br><span class="line">admin/ <span class="comment"># </span></span><br><span class="line">/ <span class="comment"># cat /etc/foo/password </span></span><br><span class="line">123456/ <span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>可以看到，Kubernetes 会在指定的路径 /etc/foo 下为每条敏感数据创建一个文件，文件名就是数据条目的 Key，这里是 /etc/foo/username 和 /etc/foo/password，Value 则以明文存放在文件中。<br>也可以自定义存放数据的文件名，比如将配置文件改为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master volumes]<span class="comment"># cat pod-secret-demo.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-secret</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: pod-secret</span><br><span class="line">    image: busybox</span><br><span class="line">    args:</span><br><span class="line">      - /bin/sh</span><br><span class="line">      - -c</span><br><span class="line">      - sleep 10;touch /tmp/healthy;sleep 30000</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: foo</span><br><span class="line">      mountPath: <span class="string">"/etc/foo"</span></span><br><span class="line">      readOnly: <span class="literal">true</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: foo</span><br><span class="line">    secret:</span><br><span class="line">      secretName: mysecret</span><br><span class="line">      items:    <span class="comment">#自定义存放数据的文件名</span></span><br><span class="line">      - key: username</span><br><span class="line">        path: my-secret/my-username</span><br><span class="line">      - key: password</span><br><span class="line">        path: my-secret/my-password</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl delete pods pod-secret</span></span><br><span class="line">pod <span class="string">"pod-secret"</span> deleted</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl apply -f pod-secret-demo.yaml </span></span><br><span class="line">pod/pod-secret created</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl exec -it pod-secret sh</span></span><br><span class="line">/ <span class="comment"># cat /etc/foo/my-secret/my-username </span></span><br><span class="line">admin</span><br><span class="line">/ <span class="comment"># cat /etc/foo/my-secret/my-password </span></span><br><span class="line">123456</span><br></pre></td></tr></table></figure>

<p>这时数据将分别存放在 /etc/foo/my-secret/my-username 和 /etc/foo/my-secret/my-password 中。</p>
<p>以 Volume 方式使用的 Secret 支持动态更新：Secret 更新后，容器中的数据也会更新。</p>
<p>将 password 更新为 abcdef，base64 编码为 YWJjZGVm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim secret.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: mysecret</span><br><span class="line">data:</span><br><span class="line">  username: YWRtaW4=</span><br><span class="line">  password: YWJjZGVm</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl apply -f secret.yaml </span></span><br><span class="line">secret/mysecret configured</span><br><span class="line">/ <span class="comment"># cat /etc/foo/my-secret/my-password </span></span><br><span class="line">abcdef</span><br></pre></td></tr></table></figure>

<p>通过 Volume 使用 Secret，容器必须从文件读取数据，会稍显麻烦，Kubernetes 还支持通过环境变量使用 Secret。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master volumes]<span class="comment"># cp pod-secret-demo.yaml pod-secret-env-demo.yaml</span></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># vim pod-secret-env-demo.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-secret-env</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: pod-secret-env</span><br><span class="line">    image: busybox</span><br><span class="line">    args:</span><br><span class="line">      - /bin/sh</span><br><span class="line">      - -c</span><br><span class="line">      - sleep 10;touch /tmp/healthy;sleep 30000</span><br><span class="line">    env:</span><br><span class="line">      - name: SECRET_USERNAME</span><br><span class="line">        valueFrom:</span><br><span class="line">          secretKeyRef:</span><br><span class="line">            name: mysecret</span><br><span class="line">            key: username</span><br><span class="line">      - name: SECRET_PASSWORD</span><br><span class="line">        valueFrom:</span><br><span class="line">          secretKeyRef:</span><br><span class="line">            name: mysecret</span><br><span class="line">            key: password</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl apply -f pod-secret-env-demo.yaml </span></span><br><span class="line">pod/pod-secret-env created</span><br><span class="line"></span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl exec -it pod-secret-env sh</span></span><br><span class="line">/ <span class="comment"># echo $SECRET_USERNAME</span></span><br><span class="line">admin</span><br><span class="line">/ <span class="comment"># echo $SECRET_PASSWORD</span></span><br><span class="line">abcdef</span><br></pre></td></tr></table></figure>

<p>通过环境变量 SECRET_USERNAME 和 SECRET_PASSWORD 成功读取到 Secret 的数据。<br>需要注意的是，环境变量读取 Secret 很方便，但无法支撑 Secret 动态更新。<br>Secret 可以为 Pod 提供密码、Token、私钥等敏感数据；对于一些非敏感数据，比如应用的配置信息，则可以用 ConfigMap。</p>
<h2 id="ConifgMap解析"><a href="#ConifgMap解析" class="headerlink" title="ConifgMap解析"></a>ConifgMap解析</h2><p>configmap是让配置文件从镜像中解耦，让镜像的可移植性和可复制性。许多应用程序会从配置文件、命令行参数或环境变量中读取配置信息。这些配置信息需要与docker image解耦，你总不能每修改一个配置就重做一个image吧？ConfigMap API给我们提供了向容器中注入配置信息的机制，ConfigMap可以被用来保存单个属性，也可以用来保存整个配置文件或者JSON二进制大对象。</p>
<p>ConfigMap API资源用来保存key-value pair配置数据，这个数据可以在pods里使用，或者被用来为像controller一样的系统组件存储配置数据。虽然ConfigMap跟Secrets类似，但是ConfigMap更方便的处理不含敏感信息的字符串。 注意：ConfigMaps不是属性配置文件的替代品。ConfigMaps只是作为多个properties文件的引用。可以把它理解为Linux系统中的/etc目录，专门用来存储配置文件的目录。下面举个例子，使用ConfigMap配置来创建Kuberntes Volumes，ConfigMap中的每个data项都会成为一个新文件。</p>
<p><strong>ConfigMap创建方式</strong></p>
<p>与 Secret 一样，ConfigMap 也支持四种创建方式：</p>
<ul>
<li>1、 通过 –from-literal：<br>每个 –from-literal 对应一个信息条目。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl create configmap nginx-config --from-literal=nginx_port=80 --from-literal=server_name=myapp.magedu.com</span></span><br><span class="line">configmap/nginx-config created</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl get cm</span></span><br><span class="line">NAME           DATA      AGE</span><br><span class="line">nginx-config   2         6s</span><br><span class="line">[root@k8s-master volumes]<span class="comment"># kubectl describe cm nginx-config</span></span><br><span class="line">Name:         nginx-config</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">server_name:</span><br><span class="line">----</span><br><span class="line">myapp.magedu.com</span><br><span class="line">nginx_port:</span><br><span class="line">----</span><br><span class="line">80</span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>2、通过 –from-file：<br>每个文件内容对应一个信息条目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master mainfests]<span class="comment"># mkdir configmap &amp;&amp; cd configmap</span></span><br><span class="line">[root@k8s-master configmap]<span class="comment"># vim www.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">	server_name myapp.magedu.com;</span><br><span class="line">	listen 80;</span><br><span class="line">	root /data/web/html;</span><br><span class="line">&#125;</span><br><span class="line">[root@k8s-master configmap]<span class="comment"># kubectl create configmap nginx-www --from-file=./www.conf </span></span><br><span class="line">configmap/nginx-www created</span><br><span class="line">[root@k8s-master configmap]<span class="comment"># kubectl get cm</span></span><br><span class="line">NAME           DATA      AGE</span><br><span class="line">nginx-config   2         3m</span><br><span class="line">nginx-www      1         4s</span><br><span class="line">[root@k8s-master configmap]<span class="comment"># kubectl get cm nginx-www -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  www.conf: <span class="string">"server &#123;\n\tserver_name myapp.magedu.com;\n\tlisten 80;\n\troot /data/web/html;\n&#125;\n"</span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: 2018-10-10T08:50:06Z</span><br><span class="line">  name: nginx-www</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">"389929"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/configmaps/nginx-www</span><br><span class="line">  uid: 7c3dfc35-cc69-11e8-801a-000c2972dc1f</span><br></pre></td></tr></table></figure>

<p><strong>使用configMap</strong></p>
<p>1、环境变量方式注入到pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master configmap]<span class="comment"># vim pod-configmap.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-cm-1</span><br><span class="line">  namespace: default</span><br><span class="line">  labels: </span><br><span class="line">    app: myapp</span><br><span class="line">    tier: frontend</span><br><span class="line">  annotations:</span><br><span class="line">    magedu.com/created-by: <span class="string">"cluster admin"</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp</span><br><span class="line">    image: ikubernetes/myapp:v1</span><br><span class="line">    ports:</span><br><span class="line">    - name: http</span><br><span class="line">      containerPort: 80 </span><br><span class="line">    env:</span><br><span class="line">    - name: NGINX_SERVER_PORT</span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: nginx-config</span><br><span class="line">          key: nginx_port</span><br><span class="line">    - name: NGINX_SERVER_NAME</span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: nginx-config</span><br><span class="line">          key: server_name</span><br><span class="line">[root@k8s-master configmap]<span class="comment"># kubectl apply -f pod-configmap.yaml </span></span><br><span class="line">pod/pod-cm-1 created</span><br><span class="line">[root@k8s-master configmap]<span class="comment"># kubectl exec -it pod-cm-1 -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># echo $NGINX_SERVER_PORT</span></span><br><span class="line">80</span><br><span class="line">/ <span class="comment"># echo $NGINX_SERVER_NAME</span></span><br><span class="line">myapp.magedu.com</span><br></pre></td></tr></table></figure>

<p>修改端口，可以发现使用环境变化注入pod中的端口不会根据配置的更改而变化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master volumes]<span class="comment">#  kubectl edit cm nginx-config</span></span><br><span class="line">configmap/nginx-config edited</span><br><span class="line">/ <span class="comment"># echo $NGINX_SERVER_PORT</span></span><br><span class="line">80</span><br></pre></td></tr></table></figure>

<p>2、存储卷方式挂载configmap：<br>Volume 形式的 ConfigMap 也支持动态更新</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master configmap ~]<span class="comment"># vim pod-configmap-2.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-cm-2</span><br><span class="line">  namespace: default</span><br><span class="line">  labels: </span><br><span class="line">    app: myapp</span><br><span class="line">    tier: frontend</span><br><span class="line">  annotations:</span><br><span class="line">    magedu.com/created-by: <span class="string">"cluster admin"</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp</span><br><span class="line">    image: ikubernetes/myapp:v1</span><br><span class="line">    ports:</span><br><span class="line">    - name: http</span><br><span class="line">      containerPort: 80 </span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginxconf</span><br><span class="line">      mountPath: /etc/nginx/config.d/</span><br><span class="line">      readOnly: <span class="literal">true</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginxconf</span><br><span class="line">    configMap:</span><br><span class="line">      name: nginx-config</span><br><span class="line">[root@k8s-master configmap ~]<span class="comment"># kubectl apply -f pod-configmap-2.yaml</span></span><br><span class="line">pod/pod-cm-2 created</span><br><span class="line">[root@k8s-master configmap ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">[root@k8s-master configmap ~]<span class="comment"># kubectl exec -it pod-cm-2 -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># cd /etc/nginx/config.d</span></span><br><span class="line">/ <span class="comment"># cat nginx_port</span></span><br><span class="line">80</span><br><span class="line">/ <span class="comment"># cat server_name </span></span><br><span class="line">myapp.magedu.com</span><br><span class="line"></span><br><span class="line">[root@k8s-master configmap ~]<span class="comment"># kubectl edit cm nginx-config  #修改端口，再在容器中查看端口是否变化。</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  nginx_port: <span class="string">"800"</span></span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">/ <span class="comment"># cat nginx_port</span></span><br><span class="line">800</span><br><span class="line">[root@k8s-master configmap ~]<span class="comment"># kubectl delete -f pod-configmap2.yaml</span></span><br></pre></td></tr></table></figure>

<p>3、以nginx-www配置nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master configmap ~]<span class="comment"># vim pod-configmap3.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-cm-3</span><br><span class="line">  namespace: default</span><br><span class="line">  labels: </span><br><span class="line">    app: myapp</span><br><span class="line">    tier: frontend</span><br><span class="line">  annotations:</span><br><span class="line">    magedu.com/created-by: <span class="string">"cluster admin"</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp</span><br><span class="line">    image: ikubernetes/myapp:v1</span><br><span class="line">    ports:</span><br><span class="line">    - name: http</span><br><span class="line">      containerPort: 80 </span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginxconf</span><br><span class="line">      mountPath: /etc/nginx/conf.d/</span><br><span class="line">      readOnly: <span class="literal">true</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginxconf</span><br><span class="line">    configMap:</span><br><span class="line">      name: nginx-www</span><br><span class="line">[root@k8s-master configmap ~]<span class="comment"># kubectl apply -f pod-configmap3.yaml</span></span><br><span class="line">pod/pod-cm-3 created</span><br><span class="line">[root@k8s-master configmap ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">[root@k8s-master configmap]<span class="comment"># kubectl exec -it pod-cm-3 -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># cd /etc/nginx/conf.d/</span></span><br><span class="line">/etc/nginx/conf.d <span class="comment"># ls</span></span><br><span class="line">www.conf</span><br><span class="line">/etc/nginx/conf.d <span class="comment"># cat www.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">	server_name myapp.magedu.com;</span><br><span class="line">	listen 80;</span><br><span class="line">	root /data/web/html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://hxqxiaoqi.gitee.io/2020/06/04/k8s之存储/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2020/06/04/nginx之php-fpm/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            nginx之php-fpm
          
        </div>
      </a>
    
    
      <a href="/2020/05/26/k8s之pod控制器/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">k8s之pod控制器</div>
      </a>
    
  </nav>

  
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2020
        <i class="ri-heart-fill heart_icon"></i> 自在
      </li>
    </ul>
    <ul>
      <li>
        
        
        
        由 <a href="https://hexo.io" target="_blank">Hexo</a> 强力驱动
        <span class="division">|</span>
        主题 - <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span></span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src="https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914"></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="自在技术博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/友情链接/">链接</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<!-- Tocbot -->

<script src="/js/tocbot.min.js"></script>
<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>
<script src="/dist/main.js"></script>
<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<script src="/js/busuanzi-2.3.pure.min.js"></script>

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->

<link rel="stylesheet" href="/css/clipboard.css">
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


    
  </div>
</body>

</html>